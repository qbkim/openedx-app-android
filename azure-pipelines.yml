trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildDir: '$(Build.SourcesDirectory)'

steps:
# üõ†Ô∏è Install Java 11 manually (if needed)
- script: |
    sudo apt-get update
    sudo apt-get install -y openjdk-11-jdk
    java -version
    export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    echo "JAVA_HOME is now set to $JAVA_HOME"
  displayName: 'Install Java 11'

# ‚úÖ Fix the conflicting SDK paths and verify Android SDK tools
- script: |
    echo "Unsetting ANDROID_SDK_ROOT to avoid SDK path conflict"
    unset ANDROID_SDK_ROOT
    export ANDROID_HOME=/opt/hostedtoolcache/AndroidSDK
    echo "ANDROID_HOME is set to $ANDROID_HOME"
    echo "JAVA_HOME is set to $JAVA_HOME"
    
    # Check if sdkmanager exists and display version
    if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
      $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --version
    else
      echo "Error: sdkmanager not found!"
    fi
  displayName: 'Fix and Verify SDK Path'

# üîß Check Environment Variables (for debugging)
- script: |
    echo "JAVA_HOME is set to $JAVA_HOME"
    echo "ANDROID_HOME is set to $ANDROID_HOME"
  displayName: 'Check Environment Variables'

# üîß Restore Gradle dependencies (optional but common)
- script: ./gradlew dependencies
  workingDirectory: $(buildDir)
  displayName: 'Restore Gradle Dependencies'

# üõ†Ô∏è Build the Android app with Java 11
- task: Gradle@3
  inputs:
    gradleWrapperFile: '$(buildDir)/gradlew'
    workingDirectory: '$(buildDir)'
    options: '--console=plain --stacktrace --info --refresh-dependencies'
    tasks: 'assembleDebug'
  displayName: 'Build Android App'

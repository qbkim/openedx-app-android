trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildDir: '$(Build.SourcesDirectory)'
  GRADLE_OPTS: '-Dorg.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m'
  ANDROID_SDK_ROOT: '/usr/local/lib/android/sdk'

steps:
# 1. Clean environment (more thorough)
- script: |
    echo "=== Cleaning environment ==="
    sudo rm -rf ~/.gradle/caches/
    sudo rm -rf ~/.gradle/daemon/
    sudo rm -rf $(buildDir)/.gradle
    sudo rm -rf $(buildDir)/build
  displayName: 'üßπ Clean Environment'

# 2. Install Java 17
- script: |
    echo "=== Installing Java 17 ==="
    sudo apt-get update -y
    sudo apt-get install -y openjdk-17-jdk
    sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
    export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
    echo "Java version: $(java -version 2>&1 | head -n 1)"
  displayName: '‚òï Install Java 17'

# 3. Setup Android SDK
- script: |
    echo "=== Setting up Android SDK ==="
    export ANDROID_HOME=$ANDROID_SDK_ROOT
    yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
    $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"
  displayName: 'ü§ñ Setup Android SDK'

# 4. Accept Gradle Terms of Service
- script: |
    echo "=== Accepting Gradle Terms ==="
    mkdir -p ~/.gradle
    echo "systemProp.gradle.termsOfServiceUrl=https://gradle.com/terms-of-service" > ~/.gradle/gradle.properties
    echo "systemProp.gradle.termsOfServiceAgree=yes" >> ~/.gradle/gradle.properties
  displayName: '‚úÖ Accept Gradle Terms'

# 5. Run Gradle build with diagnostics
- task: Gradle@3
  inputs:
    gradleWrapperFile: '$(buildDir)/gradlew'
    workingDirectory: '$(buildDir)'
    options: '--stacktrace --no-daemon --info'
    tasks: 'clean assembleDebug'
    javaHomeOption: 'Path'
    jdkDirectory: '/usr/lib/jvm/java-17-openjdk-amd64'
    publishJUnitResults: false
  env:
    CI: 'true'
  displayName: 'üõ†Ô∏è Build with Gradle'


trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildDir: '$(Build.SourcesDirectory)'

steps:
# 🛠️ Install Java 17
- script: |
    sudo apt-get update
    sudo apt-get install -y openjdk-17-jdk
    sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
    export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
    java -version
    javac -version
  displayName: 'Install and Set Java 17'

# 🔄 Verify Java version for Gradle
- script: |
    echo "Checking Java version for Gradle..."
    ./gradlew --version
  workingDirectory: $(buildDir)
  displayName: 'Verify Gradle Java Version'

# ✅ Fix Android SDK paths
- script: |
    echo "Setting Android SDK environment..."
    unset ANDROID_SDK_ROOT
    export ANDROID_HOME=/opt/hostedtoolcache/AndroidSDK
    echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
    
    # Verify SDK tools
    $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list || true
  displayName: 'Configure Android SDK'

# 🔧 Build with debug info
- task: Gradle@3
  inputs:
    gradleWrapperFile: '$(buildDir)/gradlew'
    workingDirectory: '$(buildDir)'
    options: '--stacktrace --debug'
    tasks: 'assembleDebug'
    javaHomeOption: 'Path'
    jdkDirectory: '/usr/lib/jvm/java-17-openjdk-amd64'
  displayName: 'Build with Gradle'